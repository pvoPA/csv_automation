"""
Exports vulnerability data to CSV on tanzu blob store resources
    in Prisma Cloud.

This script is used to retrieve vulnerability data for
    tanzu blob store resources and exports it to
    a CSV file with the following actions,
        - Generate Prisma Token
        - Delete the CSV file if it exists from a previous run
        - Grab tanzu blob store scan results
        - For each API call,
            - Flatten vulnerability list for each blob
            - Write to CSV (Create a CSV directory and file.)

Usage:
    python export_tanzu_blobstore_vulnerability_csv.py

Options:

Requirements:
    - Python 3.10 or higher
    - .env configured with the following variables,
        - PRISMA_ACCESS_KEY
        - PRISMA_SECRET_KEY

Example:
    python export_tanzu_blobstore_vulnerability_csv.py

Note:
    This script is meant to be deployed in the following platforms,
        - docker container
            - the app directory
        - azure function
            - the azure-function directory
        - aws lambda function
            - the aws-lambda directory
"""
import os
import json
import datetime as dt
from helpers import logger
from helpers import prisma_get_tanzu_blob_store_scan_results
from helpers import generate_prisma_token
from helpers import write_data_to_csv


def etl_tanzu_blobstore_vulnerabilities_csv():
    """
    Gets tanzu blobstore data from Prisma and cleans up for exporting to CSV.

    Parameters:
        None

    Returns:
        None

    """
    todays_date = str(dt.datetime.today()).split()[0]

    tanzu_blobstore_vulnerability_csv_name = os.getenv(
        "TANZU_BLOBSTORE_VULNERABILITY_CSV_NAME"
    )
    tanzu_blobstore_vulnerability_fields_of_interest = json.loads(
        os.getenv("TANZU_BLOBSTORE_VULNERABILITY_FIELDS_OF_INTEREST")
    )
    file_path = f"CSVs/{tanzu_blobstore_vulnerability_csv_name}_{todays_date}.csv"
    prisma_access_key = os.getenv("PRISMA_ACCESS_KEY")
    prisma_secret_key = os.getenv("PRISMA_SECRET_KEY")

    tanzu_csv_fields = [
        "packageCorrelationDone",
        "firstScanTime",
        "riskFactors",
        "packageName",
        "status",
        "cvss",
        "startupBinaries",
        "_id",
        "collections",
        "packageVersion",
        "packageManager",
        "scanTime",
        "link",
        "history",
        "osDistro",
        "distro",
        "pushTime",
        "binaries",
        "cause",
        "twistlock",
        "applications",
        "image",
        "isARM64",
        "repoDigests",
        "title",
        "discovered",
        "functionLayer",
        "labels",
        "cri",
        "creationTime",
        "Secrets",
        "complianceRiskScore",
        "tags",
        "files",
        "layerTime",
        "repoTag",
        "exploit",
        "complianceIssuesCount",
        "installedProducts",
        "type",
        "fixDate",
        "osDistroVersion",
        "id",
        "complianceIssues",
        "vecStr",
        "cve",
        "cloudMetadata",
        "applicableRules",
        "text",
        "osDistroRelease",
        "complianceDistribution",
        "description",
        "hostname",
        "templates",
        "packages",
        "allCompliance",
        "vulnerabilitiesCount",
        "vulnerabilityRiskScore",
        "published",
        "vulnerabilityDistribution",
        "severity",
        "resourceGroupName",
        "version",
        "runtime",
        "cloudControllerAddress",
        "applicationName",
        "handler",
        "provider",
        "lastModified",
        "memory",
        "architecture",
        "name",
        "timeout",
        "defended",
        "scannerVersion",
        "defenderLayerARN",
        "hash",
        "accountID",
        "region",
        "exploits",
    ]

    ######################################################################################################################
    # Generate Prisma Token

    prisma_token = generate_prisma_token(prisma_access_key, prisma_secret_key)

    ###########################################################################
    # Delete the CSV file if it exists from a previous run

    try:
        os.remove(file_path)
    except FileNotFoundError:
        pass

    ###########################################################################
    # Get blobstore data from Prisma and write to CSV

    end_of_page = False
    new_file = True
    offset = 0
    page_limit = 50

    while not end_of_page:
        (
            tanzu_blobstore_response,
            status_code,
        ) = prisma_get_tanzu_blob_store_scan_results(
            prisma_token, offset=offset, limit=page_limit
        )

        if status_code == 200:
            if tanzu_blobstore_response:
                ###############################################################
                # Flatten vulnerability list for each blob
                vulnerability_list = list()

                for blob in tanzu_blobstore_response:
                    if "vulnerabilities" in blob:
                        if blob["vulnerabilities"]:
                            for vuln in blob["vulnerabilities"]:
                                # Grab base host information
                                vulnerability_dict = {
                                    key: value
                                    for key, value in blob.items()
                                    if (
                                        key
                                        in tanzu_blobstore_vulnerability_fields_of_interest
                                    )
                                }

                                # Add the individual vulnerability information
                                vulnerability_dict.update(
                                    {
                                        key: value
                                        for key, value in vuln.items()
                                        if (
                                            key
                                            in tanzu_blobstore_vulnerability_fields_of_interest
                                        )
                                    }
                                )

                                vulnerability_list.append(vulnerability_dict)

                ###############################################################
                # Write to CSV
                write_data_to_csv(
                    file_path, vulnerability_list, tanzu_csv_fields, new_file
                )
                new_file = False

                offset += page_limit
            else:
                end_of_page = True
                break
        elif status_code == 401:
            logger.error("Prisma token timed out, generating a new one and continuing.")

            prisma_token = generate_prisma_token(prisma_access_key, prisma_secret_key)
        else:
            logger.error("API returned %s.", status_code)


if __name__ == "__main__":
    logger.info("Creating tanzu blobstore vulnerabilities CSV...")

    etl_tanzu_blobstore_vulnerabilities_csv()
